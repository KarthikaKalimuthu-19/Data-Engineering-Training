# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
  branches:
    include:
      - main   

schedules:
  - cron: "0 0 * * 1"   
    displayName: Monday Run
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: |
    python -m pip install --upgrade pip
    pip install pyspark pandas nbconvert jupyter
  displayName: "Install dependencies"

- script: |
    jupyter nbconvert --to script Azure_DevOps_Operation.ipynb --output Azure_DevOps_Operation.py
    python Azure_DevOps_Operation.py
  displayName: "Run ETL Databricks Notebook"

- script: |
    python email.py
  displayName: "Email report of 5 lowest performing stores"
  env:
    EMAIL_FROM: $(EMAIL_FROM)
    EMAIL_TO: $(EMAIL_TO)
    EMAIL_PASSWORD: $(EMAIL_PASSWORD)
